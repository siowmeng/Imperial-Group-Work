---
title: "George's Try"
author: "George Pastakas"
date: "September 25, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggthemes)
library(reshape2)
```

## Data Importing

We first import the data from the initial dataset.

```{r, echo = F}
movies <- read.csv("movie_metadata.csv", header = T, stringsAsFactors = F)
dim(movies)
```

## Data Cleaning

After we import the data, we clean them, by:

* Removing instances which have at least one NA value
* Removing duplicated instances, based on the names of the movies
* Removing the unwanted character Â, leading and trailing from the names of the movies

```{r, echo = F}
# Remove instances which have at least one NA variable
movies <- movies[complete.cases(movies), ]
# Remove instances which are duplicated (duplicated based on title)
movies <- movies[!duplicated(movies$movie_title),]
# Function to remove Â, leading and trailing whitespace from movies$movie_title
movie_title_processing <- function(str){
  str <- sub(pattern = "Â", replacement = "", str)
  str <- sub(pattern = "^\\s+|\\s+$", replacement ="", str)
}
# Apply previous function
movies$movie_title <- sapply(movies$movie_title, FUN = movie_title_processing)
dim(movies)
```

We observe that 1343 instances have removed.

## Add Variables

Based on the variables we already have in our dataset, we declare some new variables that will help us find meaningful insights. The new variables we declare are:

1. Profit: It is computes as the difference between the gross revenue of the movie and its budget.
2. Return on Investement (ROI): It is defined as the quotient of the gross revenue of the movie and its budget.
3. Profitable: It is a boolean variable which is *True* if the profit of the movie is positive, *False* otherwise.
```{r, echo = F}
# profit = revenue - budget
movies$profit <- movies$gross - movies$budget
# roi = revenue / budget
movies$roi <- movies$gross / movies$budget
# Profitable movies: profit > 0
movies$profitable <- F
movies$profitable[movies$profit > 0] <- T
```

## Remove Variables

Next, we are going to remove some of the variables of the dataset which we are not going to analyse. Those are:

* Movie's IMDb link
* Color
* Content rating
* Aspect ratio
* Number of faces in the poster

```{r, echo = F}
# We are not going to focus on these variables
movies[, c("movie_imdb_link", "color", "content_rating", "aspect_ratio", "facenumber_in_poster")] <- NULL
# Reorder columns 
movies <- movies[c("movie_title", "imdb_score", "genres", "plot_keywords", "duration", "title_year", 
                   "country", "language", "num_critic_for_reviews", "num_user_for_reviews", "num_voted_users",
                   "movie_facebook_likes", "cast_total_facebook_likes",
                   "director_name", "director_facebook_likes", "actor_1_name", "actor_1_facebook_likes",
                   "actor_2_name", "actor_2_facebook_likes", "actor_3_name", "actor_3_facebook_likes",
                   "budget", "gross", "profit", "roi", "profitable")]
dim(movies)
names(movies)
```

We end up with a dataframe of 3700 instances and 26 variable. The variables are the following:

* Title
* IMDb score
* The genres the movie belongs to
* Keywords releated with the plot of the movie
* Duration
* 
*
*
*
*
*
* Is the movie profitable or not

## Exploratory Analysis

We will start by looking some statistics about the movies. First we will start by looking the IMDb scores of the movies.

```{r, echo = F}
# Number of movies in each language
ggplot(movies, aes(imdb_score)) + 
  geom_bar(colour = "black") + coord_flip() +
  labs(title = "IMDb Score", x = "", y = "") + 
  theme(axis.ticks.y = element_blank()) +
  theme_few()
```

The mean of the IMDb score is `r mean(movies$imdb_scores)` while its standard deviation is `r sd(movies$imdb_scores)`. We see that the distribution of the socres resemples the normal distribution.

```{r, echo = F}
ggplot(movies, aes(imdb_score)) + 
  geom_density(colour = "black") +
  labs(title = "IMDb Score", x = "", y = "") + 
  stat_function(fun = dnorm, colour = "red", args = list(mean = mean(movies$imdb_score), sd = sd(movies$imdb_score))) +
  theme_few()
```

We will now explore other characteristics of the movies. First, we start with the language of the movies and their origin countries.

```{r, echo = F}
# Number of movies in each language
ggplot(movies, aes(factor(language))) + 
  geom_bar(colour = "black") + coord_flip() +
  labs(title = "Language", x = "", y = "") + 
  theme(axis.ticks.y = element_blank()) +
  theme_few()
```

```{r, echo = F}
# Number of movies in each language
ggplot(movies, aes(factor(country))) + 
  geom_bar(colour = "black") + coord_flip() +
  labs(title = "Country of Origin", x = "", y = "") + 
  theme(axis.ticks.y = element_blank()) +
  theme_few()
```

The leading countries in producing movies are the USA and the UK, and then follow France, Germany, Canada and Australia. Now we will look at the year of production.

```{r, echo = F}
# Number of movies in each language
ggplot(movies, aes(title_year)) + 
  geom_bar(colour = "black") + coord_flip() +
  labs(title = "Year of Production", x = "", y = "") + 
  theme(axis.ticks.y = element_blank()) +
  theme_few()
```

We see that during the last 3 years the production of films has decreased

Next we will move on with IMDb score, budget, profit and facebook likes of the movies. 

```{r, echo = F}
ggplot(movies, aes(x = budget, y = imdb_score)) + 
  geom_jitter(alpha = 0.2, width = 0.05) + 
  scale_x_log10(breaks = c(1e+02, 1e+04, 1e+06, 1e+08, 1e+10), 
                labels = c("100", "10,000", "1 million", "100 millions", "1 billion")) +
  labs(x = "Movie budget", y = "IMDb Score") +
  theme_few()

# Facebook likes and Budget of movie
# We remove those movies who have zero facebook likes (maybe they don't even have a facebook page)
ggplot(movies[movies$movie_facebook_likes != 0, ], 
       aes(x = movie_facebook_likes, y = imdb_score, colour = profitable)) + 
  geom_jitter(alpha = 0.2, width = 0.1) + 
  scale_x_log10(breaks = c(1e+02, 1e+04, 1e+06, 1e+08, 1e+10), 
                labels = c("100", "10,000", "1 million", "100 millions", "1 billion")) +
  labs(x = "Facebook Likes", y = "IMDB Score") +
  theme_few() +
  theme(legend.position = "None")

# Gross revenue and Budget of movie
ggplot(movies, aes(x = budget, y = gross, colour = profitable)) +
  geom_jitter(alpha = 0.2, width = 0.05) + 
  scale_x_log10(breaks = c(1e+02, 1e+04, 1e+06, 1e+08, 1e+10), 
                labels = c("100", "10,000", "1 million", "100 millions", "1 billion")) +
  scale_y_log10(breaks = c(1e+02, 1e+04, 1e+06, 1e+08, 1e+10), 
                labels = c("100", "10,000", "1 million", "100 millions", "1 billion")) +
  labs(x = "Movie budget", y = "Gross Revenue") + 
  theme_few() +
  theme(legend.position = "None")
```

We will now see the existing genres of the movies, how popular each genre is and whether there is an association between the genres of the movies and their scores and profitability.

```{r, echo = F}

#############################################

# Find all unique genres
genres <- c()
i <- 1
for (ins in movies$genres){
  g <- strsplit(ins, "[|]")
  for (gnr in g[[1]]){
    if (!(gnr %in% genres)){
      genres[i] <- gnr
      i = i + 1
    }
  }
}

# Create a dataframe with logical values which 
# indiacte the categories of each movie
movies$genres <- strsplit(movies$genres, "[|]")
genres_idx <- movies[, c("movie_title", "genres")]
i = 1
mat <- matrix(rep(0, (dim(movies)[1] * length(genres))), nrow = dim(movies)[1])
for (g in genres_idx$genres){
  idx <- which(genres %in% g)
  mat[i, idx] <- 1
  i = i + 1
}
colnames(mat) <- genres
movies_and_genres <- data.frame(mat)


# Find how many movies belong in each genre
sum <- rep(0, length(genres))
for (i in 1:length(genres)){
  sum[i] <- sum(movies_and_genres[, i])
}
genres_sum <- data.frame(genres = genres, sum = sum)

# Number of movies belonging to each genre
ggplot(genres_sum, aes(x = reorder(genres, sum), y = sum, fill = reorder(genres, sum))) + 
  geom_bar(stat = "identity", colour = "black") + coord_flip() +
  labs(title = "Movie genres", x = "", y = "") + 
  geom_text(aes(label = sum), hjust = -0.2, vjust = 0.4) + 
  theme(axis.text.x=element_blank(), axis.ticks.x = element_blank(), axis.ticks.y = element_blank()) + 
  theme_few() +
  theme(legend.position = "None") 


######################################################
movies_and_genres <- cbind(movie_title = genres_idx$movie_title, score = movies$imdb_score, 
                           profit = movies$profit, movies_and_genres, stringsAsFactors = F)



movies_and_genres2 <- melt(movies_and_genres, id = c("movie_title", "score", "profit"))

x <- merge(movies_and_genres2, movies, by = c("movie_title", "movie_title"))
x$genres <- NULL

ggplot(movies_and_genres2, aes(x = profit, y = score, colour = variable)) + 
  geom_jitter(alpha = 0.1) +
  scale_x_log10(breaks = c(1e+02, 1e+04, 1e+06, 1e+08, 1e+10), 
                labels = c("100", "10,000", "1 million", "100 millions", "1 billion")) +
  labs(x = "Profit", y = "IMDb Score") +
  theme_few()
```


