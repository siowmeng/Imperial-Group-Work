---
title: "Louise - Predictive Model"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(ggthemes)
library(ggrepel)
library(reshape2)
library(dplyr)
library(plyr)
library(caret)
library(scales)
library(countrycode)
library(GGally)
```

```{r, echo = FALSE}
movies <- read.csv(file = "movie_metadata.csv", header = TRUE, stringsAsFactors = FALSE, strip.white = TRUE)
```


```{r, echo = FALSE}
## function to calculate list of NAs within a column
colNA <- function(dfCol){ sum(is.na(dfCol)) }
## To show table of sum of NAs by column
apply(movies, 2, colNA)
```


```{r, echo = FALSE}
## To remove rows where NAs are present for any of the applicable columns
movies <- movies[complete.cases(movies[c("title_year","budget","gross")]),]
## To remove aspect ratio and imdb link columns
movies$aspect_ratio<- NULL
movies$movie_imdb_link<- NULL
## To show table of sum of NAs by column
apply(movies, 2, colNA)
```

```{r, echo = FALSE}
## for loop to replace NAs with means for particular columns
for (i in c("actor_1_facebook_likes" , "actor_2_facebook_likes" , "actor_3_facebook_likes" , "num_critic_for_reviews" , "duration" , "facenumber_in_poster"))
 {k <- which(colnames(movies)==i)
 movies[k][is.na(movies[k]==TRUE)] <- round(mean(movies[[k]], na.rm=TRUE),0)}
```

```{r, echo = FALSE}
movies <- movies[!duplicated(movies$movie_title),]
# Function to remove Â, leading and trailing whitespace from movies$movie_title
movie_title_processing <- function(str){
  str <- sub(pattern = "Â", replacement = "", str)
  str <- sub(pattern = "^\\s+|\\s+$", replacement ="", str)
}
# Apply previous function
movies$movie_title <- sapply(movies$movie_title, FUN = movie_title_processing)
```

```{r, echo = FALSE, message = FALSE}
set.seed(1)
intrain <- createDataPartition(y = movies[[1]], p = 0.9, list = FALSE)
train <- movies[intrain, ]
test <- movies[-intrain, ]
```

```{r echo=FALSE}
traindirectorsummary <- ddply(train, ~ director_name,summarise, number_of_movies=length(director_name))
##add a categorical variable for ten movies or more
traindirectorsummary$more_than_ten_movies <- rep("Fewer than 10", nrow(traindirectorsummary))
traindirectorsummary$more_than_ten_movies[traindirectorsummary$number_of_movies>10] <- "10+"
trainwithdirectordata <- merge(train, traindirectorsummary[,c("director_name","more_than_ten_movies")], by="director_name")
##set factors so that Fewer than Ten is the default variable, and 10+ will show in the model
trainwithdirectordata$more_than_ten_movies <- factor(trainwithdirectordata$more_than_ten_movies, levels=c("Fewer than 10", "10+"))
```

```{r echo=FALSE}
directormodel <- lm(gross ~ more_than_ten_movies + budget + imdb_score + num_voted_users + content_rating + duration + cast_total_facebook_likes + director_facebook_likes + movie_facebook_likes, data=trainwithdirectordata[trainwithdirectordata$title_year >= 2010,])
summary(directormodel)
```

###Justification
###Variables included in the model:
* Inferential analysis showed that whether or not the director has more than ten movies in the sample is correlated with the mean of gross revenue, so this is included as a dependent variable.
* Inferential analysis also showed that the budget of a movie is positively correlated with the gross revenue, which can be interpreted as movie-makers being wise enough to get a high return on investment.
* IMDB score can be seen as the "quality" of a movie, as voted on by the public. At first look this variable is positively correlated with the gross revenue, but interestingly the coefficient for this variable is negative once the "number of user reviews" variable is included. An interpretation of this is that the popularity of a movie is more fully explained by the number of people reviewing the movie, and after this is taken into account, the movies with a higher "quality", as measured by imdb score, actually do less well in the box office. This could be because people are more likely to go and vote on imdb for movies they liked, and also for the obvious reason that people are more likely to go and vote on imdb for movies they have seen, so number of user reviews will be linked to number of cinema tickets sold, which is linked to gross revenue.
* Inferential analysis also showed that for a few of the key ratings (G, PG and PG-13) there was some impact on gross revenue, so rating has been included in the model.
* The duration, when included into the model has a statistically significant positive coefficient, this could be interpreted as movie-goers perceiving longer movies as more value for money or higher quality.
* Cast total facebook likes can also be seen as a potential predictor for gross revenue, as in theory the more popular the actor (measured by facebook likes), the more people will go to see the movie to see that actor, the more tickets are sold and therefore the higher the revenue. We can see from the positive coefficient that this seems to be reflected in the data.
* Director facebook likes is statistically significant when included into the model, interestingly with a negative coefficient. Again, this variable is at first glance positively correlated with the gross revenue, however once you take into account the number of voted users, this relationship is reversed, potentially for similar reasons to the above.
* Movie facebook likes is also statistically significant when included into the model, this can be interpreted as a proxy for the popularity of the movie, and also could be that the more people who saw the movie (based on gross revenue), the more people then subsequently liked the page.

###Not included into the model
* Movie title, director name, genres, plot keywords, and actor names were not included into the variable as there many different values for these variables with a small number of observations (usually one observation) for each.
* Number of critic reviews is quite highly correlated with the number of user reviews, with a correlation coefficient of (`r round(cor(movies$num_user_for_reviews,movies$num_critic_for_reviews),2)). So it was decided to include only one of these variable into the model, in this case number of user reviews.
* When decade is included then none are found to be statistically significant, after other variables are included.
* When color is included into the model then none of the options are found to be statistically significant, there is also not a very large variation in this variable in the sample set.
```{r echo=FALSE}
ggplot(movies, aes(x=color)) + geom_bar() + xlab("")
```
* When either language or country are included into the model, the R squared does go up, but by less than 0.01, and this also includes a lot of additional values to be interpreted, so the model loses some interpretability. Due to this, these factors have been left out. 
* The multpiple actor "facebook likes" variables are mostly correlated with each other, as can be seen from the correlation matrix, so the total cast facebook likes has been chosen as the "overall" variable to explain the effects of facebook popularity of the cast.
* The number of faces in the poster has not been included into the model, when included it is only slightly statistically significant, and the intuition behind this variable is unclear, so including it may lead to model overfitting.

##Second Model, with only pre-known variables

```{r echo=FALSE}
directormodelknownvariables <- lm(gross ~ more_than_ten_movies + budget + content_rating + duration + cast_total_facebook_likes + director_facebook_likes + movie_facebook_likes, data=trainwithdirectordata[trainwithdirectordata >= 2010])
summary(directormodelknownvariables)
```

To build a model to predict revenue of movies that have not yet been released, we include only variables that are known before the time of release. Our dataset provided us with number of facebook likes at a specific point in time, and to use this as part of our predictive model we would need to analyse number of facebook likes before the movie was released, however we will use what we currently have as a proxy to build the model. This model has much lower predictive power (adjusted R squared of `r summary(directormodelknownvariables)$adj.r.squared`), but could be used in a more usefull business context.

```{r dependson="gv",results="asis", eval=FALSE}
library(googleVis)
moviesbycountry <- ddply(movies, ~ country ,summarise, number_of_movies=length(country))
Geo=gvisGeoChart(moviesbycountry, locationvar="country", 
                 colorvar="number_of_movies",
                 options=list(projection="kavrayskiy-vii"))
plot(Geo)
```

```{r eval=FALSE}
library(rworldmap)
map.world <- map_data(map="world")

#Add the data you want to map countries by to map.world
#In this example, I add lengths of country names plus some offset
map.world$name_len <- nchar(map.world$region) + sample(nrow(map.world))

gg <- ggplot()
gg <- gg + theme(legend.position="none")
gg <- gg + geom_map(data=map.world, map=map.world, aes(map_id=region, x=long, y=lat, fill=name_len))

gg <- gg + scale_fill_gradient(low = "green", high = "brown3", guide = "colourbar")
gg <- gg + coord_equal()
gg
```