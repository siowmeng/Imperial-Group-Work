---
title: "Steven_movie_analysis"
author: "Steven Locorotondo"
date: "09/26/2016"
output: pdf_document
---

```{r echo = FALSE}
setwd('/Users/Steven/Desktop/')
movies <- read.csv(file="movie_metadata.csv", head = TRUE, strip.white = TRUE)
```

Import libraries for cleaning and analyzing data

```{r message = "hide"}
library(ggplot2)
library(ggthemes)
library(knitr)  # for table
library(countrycode)
library(dplyr)
library(GGally)
```
## Introduction

Purpose of report

## Data

The dataset used in this report was downloaded from *kaggle.com*, a website for data analysis competitions. The data was scraped from three websites using *Scrapy*, a Python library. The first website, *the-numbers.com*, is a website providing movie industry data. This first website was used to scrape 5000 movies names along with other relevant data such as budget and gross domestic revenue. The scraped data was then matched with *imdb.com*, a popular resource for movie and TV-show ratings, and celebrity content, in order to get movie scores, direct links to movie pages, and other data. All the the movie and actor names were then aggregated and used to extract the number of Facebook likes on their respective official Facebook page. Finally, a face detection algorithm was applied to all movie posters to extract the number of faces in each poster. The dataset contains `r dim(movies)[1]` movies with `r dim(movies)[2]` variables spanning 100 years and 66 countries of origin.    
   
Although *imdb.com* covers movies from various different countries, the website is only offered in English, which implies certain limitations. The movies included in the dataset are skewed towards an English-speaking audience. This means that movies from North America, the UK, and other English speaking countries are overrepresented. In addition, the dataset includes more movies with release dates after 1980. In fact, multiple release years prior to 1980 include as little as one movie. NA?  
   
Despite these limitations the dataset offers extensive information on movies as well as a large enough number of observations. This will allow the analysis to  reveal interesting insights and answer the reports leading question. The dataset can be retrieved [here](https://www.kaggle.com/deepmatrix/imdb-5000-movie-dataset).

The dataset includes the following variables:
```{r echo = FALSE}
# make table with column names and explanations

# create new df with column names ar rows
movie_variables <- colnames(movies)
movie_variables <- data.frame(sort(movie_variables))
# rename fisrt column
colnames(movie_variables) <- ("Variable Name")

actor_1_facebook_likes <- "Number of likes on main actor's Facebook page."
actor_1_name <- "Main actor's name."
actor_2_facebook_likes <- "Number of likes on first supporting actor's Facebook page."
actor_2_name <- "First supporting actor's name."
actor_3_facebook_likes <- "Number of likes on second supporting actor's Facebook page."
actor_3_name <- "Second supporting actor's name."
aspect_ratio <- "Aspect ratio the movie was shot in."
budget <- "Budget in USD. All budget's are estimates based on press reports."
cast_total_facebook_likes <- "Total number of likes of all actor Facebook pages."
color <- "Describes whether the movie was shot in color or black and white"
content_rating <- "Rating of suitability of movie for audience."
country <- "Country the movie was shot in. If the movie was shot in more than one country only the first country appearing was chosen. Throughout the analysis this variable will serve as proxy for the country of origin."
director_facebook_likes <- "Number of likes on director's Facebook page."
director_name <- "Name of director."
duration <- "Movie length in minutes."
facenumber_in_poster <- "Number of faces on movie poster."
genres <- "Movie genre."
gross <- "Latest domestic gross revenue reported on the-number.com, in USD."
imdb_score <- "Score voted by IMDB users, from 1 to 10 (highest)."
language <- "Language in which movie was shot."
movie_facebook_likes <- "Number of likes on movie's official Facebook page."
movie_imdb_link <- "Link to movie page."
movie_title <- "Movie name."
num_critic_for_reviews <- "Number of critics that wrote a review."
num_user_for_reviews <- "Number of imdb users that wrote a review."
num_voted_users <- "Number of imdb users that gave a rating."
plot_keywords <- "Keywords describing the movie plot."
title_year <- "Movie release year."

# initiate new column for explanations
movie_variables$Explanation <- c(actor_1_facebook_likes,
                                 actor_1_name,
                                 actor_2_facebook_likes,
                                 actor_2_name,
                                 actor_3_facebook_likes,
                                 actor_3_name,
                                 aspect_ratio,
                                 budget,
                                 cast_total_facebook_likes,
                                 color,
                                 content_rating,
                                 country,
                                 director_facebook_likes,
                                 director_name,
                                 duration,
                                 facenumber_in_poster,
                                 genres,
                                 gross,
                                 imdb_score,
                                 language,
                                 movie_facebook_likes,
                                 movie_imdb_link,
                                 movie_title,
                                 num_critic_for_reviews,
                                 num_user_for_reviews,
                                 num_voted_users,
                                 plot_keywords,
                                 title_year)

# create table
kable(movie_variables, format = "markdown")
```

## Exploration and Cleaning of Raw Data

```{r echo = FALSE}
head(movies)
```

A first look at the raw data reveals unwanted characters in the movie_title column. The following code removes them.

```{r}
# convert column to matrix
mat <- as.matrix(movies$movie_title)

# remove unwanted characters from every entry
for (i in 1:nrow(mat)) {
  mat[i] <- gsub("\xe5\xca", "", mat[i])
}

# assign new values to original data frame
movies$movie_title <- mat
```

Strip white trailing and leading white space
```{r}
# function for removing trailing and leading white space
trim <- function (x) gsub("^\\s+|\\s+$", "", x)

# apply function to every column of data frame
for (i in 1:ncol(movies)) {
  if (is.character(movies[,i])) {
    movies[,i] <- trim(movies[,i])
  }
}
```
The anyDuplicated function call reveils that there are duplicates in our data. We remove them by calling the unique function.
```{r}
any(anyDuplicated(movies))

# remove duplicates
movies <- unique(movies)

# find row number of "Dekalog" as unique function doesn't delete this
which(movies$movie_title == "Dekalog")

# remove "Dekalog" entry as it is represented twice but with a different amount of facebook likes. Row number 2802
movies <- movies[-2802, ]
```

## Preliminary Visualizations

Univariate distributions

Histograms for IMDB scores and gross revenue
```{r}
ggplot(movies, aes(x = imdb_score)) + geom_histogram(binwidth = 0.05)

ggplot(movies, aes(x = gross)) + geom_histogram() + stat_bin(bins = 30)
```

The above graph shows the distribution of IMDB scores for the movies. It appears to follow a normal distribution with a mean of **`r mean(movies$imdb_score)`** and a standard deviation of **`r sd(movies$imdb_score)`**.

Univartiate graph for IMDB scores and gross revenue
```{r}
# first add group column to use as y axis
movies$group <- 0

# IMDB scores
ggplot(movies, aes(x = imdb_score, y= group)) + geom_jitter() + scale_y_continuous(limits=c(-2, 2))

# Gross revenue
ggplot(movies, aes(x = gross, y= group)) + geom_jitter() + scale_y_continuous(limits=c(-2, 2))
```

Add continents columns
```{r}
# add continent column
movies$continent <- countrycode(as.character(movies$country), "country.name", "continent")

# divide "Americas" into "North Americas" and "South America"
south_America = c("Brazil", "Argentina", "Chile", "Colombia", "Peru")

for (i in 1:nrow(movies)) {
  if (is.na(movies$continent[i])) {
    next
  } else if ((movies$continent[i] == "Americas") & (movies$country[i] %in% south_America)) {
    movies$continent[i] <- "South America"
  } else if ((movies$continent[i] == "Americas") & (!(movies$country[i] %in% south_America))) {
    movies$continent[i] <- "North America"
  } 
}
```

Europe IMDB score boxplot
```{r}
temp <- movies[movies$continent == "Europe", ]

ggplot(temp, aes(x = country, y = imdb_score)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5)) +
  labs(title = "IMDB scores against European countries", x = "", y = "IMDB Score")
```

Americas IMDB boxplot
```{r}
# Americas
temp <- movies[movies$continent == c("North America", "South America"),]

ggplot(temp, aes(x = country, y = imdb_score)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5)) +
  labs(title = "IMDB scores against Americas", x = "", y = "IMDB Score")

# North America
temp <- movies[movies$continent == "North America",]

ggplot(temp, aes(x = country, y = imdb_score)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5)) +
  labs(title = "IMDB scores against North America", x = "", y = "IMDB Score")

# South America
temp <- movies[movies$continent == "South America",]

ggplot(temp, aes(x = country, y = imdb_score)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5)) +
  labs(title = "IMDB scores against South America", x = "", y = "IMDB Score")
```

Boxplot IMDB scores against content rating
```{r}
# need to remove rows where content rating is ""
ggplot(movies[!movies$content_rating == "", ], aes(x = content_rating, y = imdb_score)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5)) +
  labs(title = "IMDB scores against content rating", x = "", y = "IMDB Score")
```

Boxplot IMDB scores against countries and countries with at least ten movies
```{r}
# need to remove rows where country is ""
ggplot(movies[!movies$country == "", ], aes(x = country, y = imdb_score)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5)) +
  labs(title = "IMDB scores against country", x = "", y = "IMDB Score")
```

Boxplot IMDB scores against year, decade
```{r}
# for all countries and all years
# remove NA from title_year column first 
temp <- movies[!is.na(movies$title_year),]
ggplot(temp, aes(x = factor(title_year), y = imdb_score, fill = factor(title_year))) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against year", x = "", y = "IMDB Score")

# make decade column
for (i in 1:nrow(movies)){
  low <- movies$title_year[i] - (movies$title_year[i] %% 10)
  high <- movies$title_year[i] - (movies$title_year[i] %% 10) + 9
  movies$decade[i] <- paste(as.character(low), as.character(high), sep = "-")
}

# for all countries by decade
# remove entries with NA-NA
temp <- movies[!movies$decade == "NA-NA", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against decade, all countries", x = "", y = "IMDB Score")

# for Europe
temp <- movies[!movies$decade == "NA-NA", ]
temp <- temp[temp$continent == "Europe", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against decade, Europe", x = "", y = "IMDB Score")

# for North America
temp <- movies[!movies$decade == "NA-NA", ]
temp <- temp[temp$continent == "North America", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against decade, North America", x = "", y = "IMDB Score")

# for France
temp <- movies[!movies$decade == "NA-NA", ]
temp <- temp[temp$country == "France", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5),legend.position = "None") +
  labs(title = "IMDB scores against decade, France", x = "", y = "IMDB Score")

# for Germany
temp <- movies[!movies$decade == "NA-NA", ]
temp <- temp[temp$country == "Germany", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against decade, Germany", x = "", y = "IMDB Score")

# for USA
temp <- movies[!movies$decade == "NA-NA", ]
temp <- temp[temp$country == "USA", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against decade, USA", x = "", y = "IMDB Score")

# for UK
temp <- movies[!movies$decade == "NA-NA", ]
temp <- temp[temp$country == "UK", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against decade, UK", x = "", y = "IMDB Score")

# for India
temp <- movies[!movies$decade == "NA-NA", ]
temp <- temp[temp$country == "India", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against decade, India", x = "", y = "IMDB Score")

# for China
temp <- movies[!movies$decade == "NA-NA", ]
temp <- temp[temp$country == "China", ]
ggplot(temp, aes(x = decade, y = imdb_score, fill = decade)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=45, hjust=0.5, vjust=0.5), legend.position = "None") +
  labs(title = "IMDB scores against decade, China", x = "", y = "IMDB Score")
```

```{r}
ggplot(movies, aes(x = imdb_score, y = gross)) + geom_point() + geom_smooth(method = "lm", se = FALSE)
```

The above graph plots Y against IMBD scores. There appears to be some positive correlation between IMBD scores and the revenues produced by a movie. This follows the initial intuition that popular movies generate more revenue.

```{r}
temp <- movies[order(movies$imdb_score,decreasing=TRUE), ]
temp <- temp[1:10,]
ggplot(temp, aes(x = temp$movie_title, y = temp$imdb_score)) + geom_bar(stat = "identity") + coord_flip()
```


## Inferential Analysis
Test whether, on average, European movies get higher IMDB scores than North American ones.
H0 -> Europe and North America get equal scores
```{r}
# make dataframes for North America and Europe
North_America <- movies[movies$continent == "North America",]
Europe <- movies[movies$continent == "Europe",]

# separate IMDB scores 
North_America <- North_America[, c("imdb_score", "continent")]
Europe <- Europe[, c("imdb_score", "continent")]

t.test(Europe$imdb_score, North_America$imdb_score)

# combine two data frames
comb <- rbind(Europe, North_America)

# plot densities
ggplot(comb, aes(x = comb$imdb_score)) +
  geom_density() +
  geom_density(aes(x = comb$imdb_score, fill = continent, alpha = 0.3)) +
  xlab("IMDB score")
```

## Data Cleaning

Before analyzing

## Regression model
```{r}
# make data frame with only numeric colums
num_movies <- movies[,sapply(movies, is.numeric)]

# drop group column
num_movies$group <- NULL

cols = c("budget", "gross", "cast_total_facebook_likes", "actor_1_facebook_likes")

# create function for regression plots in ggpairs
my_fn1 <- function(data, mapping){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_point(alpha = 0.4) + 
    geom_smooth(method=loess, fill="red", color="red") +
    geom_smooth(method=lm, fill="blue", color="blue") +
    scale_x_log10() +
    scale_y_log10()
}

# create function for density plots
my_fn2 <- function(data, mapping){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_density() + 
    scale_x_log10()
}

ggpairs(num_movies, columns = cols, lower = list(continuous = my_fn1), diag = list(continious = my_fn2))
```

```{r, echo = FALSE}
mdl_imdb <- lm(imdb_score ~ budget + cast_total_facebook_likes + director_facebook_likes + duration, data = movies[movies$title_year >= 2010, ])

summary(mdl_imdb)
```

```{r, echo = FALSE}
mdl_gross <- lm(gross ~ budget + cast_total_facebook_likes + director_facebook_likes + duration, data = movies[movies$title_year >= 1980, ])

summary(mdl_gross)
```

## Notes

* check if US makes more violent movies than other top countries (chi^2-test)
* get rid of whitespace in movie_title
* check if there are duplicates and remove them
* compare IMDB scores of two years
* movies per capita

| hello || World|
|--------||-----|
|data||data|